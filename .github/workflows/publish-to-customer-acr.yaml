name: Build and Deploy Docker Container to Customer ACR

on:
  workflow_call:
    inputs:
      image-name:
        required: true
        type: string
      version:
        required: true
        type: string
    secrets:
      token:
        required: true
      AZURE_SECRETS:
        required: true
      CLUSTER_NAME:
        required: true
      RESOURCE_GROUP:
        required: true
      REGISTRY:
        required: true

env:
  IMAGE_NAME: ${{ inputs.image-name }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: dist
        path: dist
    - name: show contents
      run: ls -la
    - name: show dist
      run: ls -la dist

    - name: Setup Azure credentials
      run: |
        # Parse AZURE_SECRETS and export variables
        echo "${{ secrets.AZURE_SECRETS }}" | while IFS= read -r line; do
          if [[ $line == export* ]]; then
            # Remove 'export ' prefix and any comments
            var_assignment=$(echo "$line" | sed 's/^export //' | sed 's/ *#.*//')
            if [[ $var_assignment == *=* ]]; then
              echo "$var_assignment" >> $GITHUB_ENV
            fi
          fi
        done

    - name: Validate Azure credentials
      run: |
        if [ -z "$ARM_CLIENT_ID" ]; then
          echo "ARM_CLIENT_ID is empty. Exiting."
          exit 1
        fi
        if [ -z "$ARM_CLIENT_SECRET" ]; then
          echo "ARM_CLIENT_SECRET is empty. Exiting."
          exit 1
        fi
        if [ -z "$ARM_TENANT_ID" ]; then
          echo "ARM_TENANT_ID is empty. Exiting."
          exit 1
        fi
        if [ -z "$ARM_SUBSCRIPTION_ID" ]; then
          echo "ARM_SUBSCRIPTION_ID is empty. Exiting."
          exit 1
        fi
        echo "Azure credentials validated successfully"
        echo "- Tenant ID: $ARM_TENANT_ID"
        echo "- Subscription ID: $ARM_SUBSCRIPTION_ID"

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: |
          {
            "clientId": "${{ env.ARM_CLIENT_ID }}",
            "clientSecret": "${{ env.ARM_CLIENT_SECRET }}",
            "subscriptionId": "${{ env.ARM_SUBSCRIPTION_ID }}",
            "tenantId": "${{ env.ARM_TENANT_ID }}"
          }

    - name: Login to Azure Container Registry
      run: |
        az acr login --name ${{ secrets.REGISTRY }}

    - name: Build Docker image
      run: |
        docker build -t ${{ secrets.REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} .
        docker tag ${{ secrets.REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} ${{ secrets.REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
        docker tag ${{ secrets.REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} ${{ secrets.REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ inputs.version }}

    - name: Push Docker image
      run: |
        docker push ${{ secrets.REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}
        docker push ${{ secrets.REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:latest
        docker push ${{ secrets.REGISTRY }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ inputs.version }}


    