name: Create Kubernetes Secrets from Azure Key Vault

on:
  workflow_call:
    inputs:
      secret-name:
        description: 'Name of the Kubernetes secret to create'
        required: true
        type: string
      namespace:
        description: 'Kubernetes namespace to deploy the secret to'
        required: true
        type: string
    secrets:
      APPLICATION_SECRETS:
        description: 'Application secrets in format: export KEY=value (one per line)'
        required: true
      AZURE_SECRETS:
        description: 'Azure credentials in format: export ARM_CLIENT_ID=..., etc.'
        required: true
      CLUSTER_NAME:
        description: 'AKS cluster name'
        required: true
      RESOURCE_GROUP:
        description: 'Azure resource group name'
        required: true

jobs:
  create-secrets:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Azure credentials
      run: |
        # Parse AZURE_SECRETS and export variables
        echo "${{ secrets.AZURE_SECRETS }}" | while IFS= read -r line; do
          if [[ $line == export* ]]; then
            # Remove 'export ' prefix and any comments
            var_assignment=$(echo "$line" | sed 's/^export //' | sed 's/ *#.*//')
            if [[ $var_assignment == *=* ]]; then
              echo "$var_assignment" >> $GITHUB_ENV
            fi
          fi
        done

    - name: Validate Azure credentials
      run: |
        if [ -z "$ARM_CLIENT_ID" ]; then
          echo "ARM_CLIENT_ID is empty. Exiting."
          exit 1
        fi
        if [ -z "$ARM_CLIENT_SECRET" ]; then
          echo "ARM_CLIENT_SECRET is empty. Exiting."
          exit 1
        fi
        if [ -z "$ARM_TENANT_ID" ]; then
          echo "ARM_TENANT_ID is empty. Exiting."
          exit 1
        fi
        if [ -z "$ARM_SUBSCRIPTION_ID" ]; then
          echo "ARM_SUBSCRIPTION_ID is empty. Exiting."
          exit 1
        fi
        echo "Azure credentials validated successfully"
        echo "- Tenant ID: $ARM_TENANT_ID"
        echo "- Subscription ID: $ARM_SUBSCRIPTION_ID"

    - name: Azure Login
      uses: azure/login@v1
      with:
        creds: |
          {
            "clientId": "${{ env.ARM_CLIENT_ID }}",
            "clientSecret": "${{ env.ARM_CLIENT_SECRET }}",
            "subscriptionId": "${{ env.ARM_SUBSCRIPTION_ID }}",
            "tenantId": "${{ env.ARM_TENANT_ID }}"
          }

    - name: Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'

    - name: Install kubelogin
      run: |
        curl -LO "https://github.com/Azure/kubelogin/releases/download/v0.0.32/kubelogin-linux-amd64.zip"
        unzip kubelogin-linux-amd64.zip
        sudo mv bin/linux_amd64/kubelogin /usr/local/bin/
        rm -rf kubelogin-linux-amd64.zip bin/

    - name: Configure kubectl
      run: |
        az aks get-credentials --resource-group ${{ secrets.RESOURCE_GROUP }} --name ${{ secrets.CLUSTER_NAME }}
        kubelogin convert-kubeconfig -l azurecli


    - name: Create namespace if it doesn't exist
      run: |
        if ! kubectl get namespace ${{ inputs.namespace }} 2>/dev/null; then
          echo "Creating namespace: ${{ inputs.namespace }}"
          kubectl create namespace ${{ inputs.namespace }}
        else
          echo "Namespace ${{ inputs.namespace }} already exists"
        fi

    - name: Parse secrets and create Kubernetes secret YAML
      run: |
        cat > secret.yaml <<EOF
        apiVersion: v1
        kind: Secret
        metadata:
          name: ${{ inputs.secret-name }}
          namespace: ${{ inputs.namespace }}
        type: Opaque
        data:
        EOF

        # Parse APPLICATION_SECRETS and add each key-value pair as base64 encoded
        echo "${{ secrets.APPLICATION_SECRETS }}" | while IFS= read -r line; do
          # Skip empty lines and comments
          [[ -z "$line" || "$line" =~ ^[[:space:]]*# ]] && continue

          if [[ $line == export* ]]; then
            # Remove 'export ' prefix and any comments
            var_assignment=$(echo "$line" | sed 's/^export //' | sed 's/ *#.*//')

            if [[ $var_assignment == *=* ]]; then
              # Split into key and value
              key=$(echo "$var_assignment" | cut -d'=' -f1 | xargs)
              value=$(echo "$var_assignment" | cut -d'=' -f2- | xargs)

              # Base64 encode the value
              encoded_value=$(echo -n "$value" | base64 -w 0)

              # Add to YAML
              echo "  $key: $encoded_value" >> secret.yaml
              echo "Added secret key: $key"
            fi
          fi
        done

        echo "Generated secret.yaml:"
        cat secret.yaml

    - name: Apply Kubernetes secret
      run: |
        kubectl apply -f secret.yaml -n ${{ inputs.namespace }}
        echo "Secret ${{ inputs.secret-name }} created/updated in namespace ${{ inputs.namespace }}"

    - name: Verify secret creation
      run: |
        echo "Verifying secret exists..."
        kubectl get secret ${{ inputs.secret-name }} -n ${{ inputs.namespace }}
        echo "Secret keys:"
        kubectl get secret ${{ inputs.secret-name }} -n ${{ inputs.namespace }} -o jsonpath='{.data}' | jq 'keys'